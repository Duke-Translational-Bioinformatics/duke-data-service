# DDS-1061 Optimized Directory Structure Endpoint

## Deployment View

status: submitted for review

###### Deployment Requirements

## Logical View

The goal of this development epic is to produce a set of endpoints to be used in place of the `/projects/:id/children` and `/folders/:id/children` endpoints.

#### Background

The legacy children endpoints have proven to be suboptimal for the GCB clients needs. The GCB client needs an endpoint or set of endpoints to facilitate uploading and downloading of multiple files, usually entire projects. The current children endpoints meet the information needs for their use, but it currently takes on average 15 minutes to get the directory structure for a project or folder with many subfolders and files (similar to our ua_test sprawl project).

#### Proposal

In this feature epic we will engage the GCB dds_client development team for feedback on two areas:

- determine minimal query parameters required for their needs
- designing a response document with the minimal fields required to meet the dds_client requirements
- include deleted children in response documents to facilitate detection of changes in the overall filesystem
- sort children in order of last_updated_on to ensure most recently changed objects come out first in responses

#### Document Design

We started with an exemplar of the response provided by the current children endpoint. The goal of this phase was to tease out the specific information in this response, and craft a new JSON structure with these specific pieces of information only. This was used to create a proposed Summary of impacted APIs and API Specification (below).

## Implementation View

#### Summary of impacted APIs

|Endpoint |Description |
|---|---|
| `GET /projects/:id/files` | Get list of files in a project. |

#### API Specification

##### List project / folder files

`GET /projects/{id}/files`

###### Permission

The `download_file` permission is required because the `file_url` attribute is
being returned. This could be reduced to `view_project`, with the `file_url`
attribute omitted unless the `download_file` permission is pressent.

###### Response Example

Standard Pagination Headers are used for paginated responses.

```JSON
{
  "results": [
    { "id": "4b24c20b-a4ed-4910-b51a-b747c76c4518",
      "name": "here.pyc",
      "size": 5843,
      "ancestor_names": [
        "project_name",
        "foo",
        "bar"
      ],
      "hashes": [
        {
          "algorithm": "md5",
          "value": "866aecf23d71d084133007b6122f1be5"
        }
      ],
      "url": "https://swift.domain.com/v1/AUTH_xxxx/abcd/efg/?temp_url_sig=030303&temp_url_expires=1518192780&filename=file.txt" }
  ]
}
```

***Notes***

- `ancestor_names` can be construed as a path hierarchy, e.g. the first element is always the project_name, subsequent elements are folders with nesting defined by their ordinal position in the array. For example, a unix path could be constructed from the file in the above example as `project_name/foo/bar/here.pyc`

- `url` is the same temporary swift download url generated by `/files/{id}/url`. If the temporary download url expires before the download is attempted, it can be generated using the `/files/{id}/url` endpoint with the id provided in the result entry payload.

## Process View

Add notes about performance, scalability, throughput, etc. here. These can inform future proposals to change the implementation.
