machine:
  environment:
    DDSURL: http://0.0.0.0:3001
    COMPOSE_FILE: docker-compose.circle.yml
  hosts:
    swift.circle.host: 0.0.0.0
  services:
    - docker

  # Version of ruby to use
  ruby:
    version:
      2.2.2

dependencies:
  cache_directories:
    - "docker/circle"
  pre:
    - ./docker/circle/cache_ruby.sh
    - ./docker/circle/cache_dredd.sh
    - curl -L https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64 > jq; sudo mv jq /usr/bin/jq; sudo chmod +x /usr/bin/jq
    - sudo pip install --upgrade docker-compose==1.3.0
    - ./circle/launch_application.circle.sh

test:
 post:
  #- './workflow/workflow.circle.sh'
  - 'docker-compose run dredd'
  #- 'docker run -it -v /home/ubuntu/duke-data-service/docker/builds/dredd/dredd_scripts:/dds --env HOST_NAME=https://dukeds-dev.herokuapp.com/api/v1 --env MY_GENERATED_JWT=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6IjRhYmZiNWYyLWRmMTItNDQ3ZC1hMGQ5LWU0NzgzMDg2N2FjZSIsInNlcnZpY2VfaWQiOiIzNDJjMDc1YS03YWNhLTRjMzUtYjNmNS0yOWYwNDM4ODRiNWIiLCJleHAiOjE0NTAxMjg2Njh9.pCATJGb9ilVo0ScTnVYazCw0D8s1muaxnf0gqBUIUGA dukedataservice_dredd  /bin/bash
  #- 'docker run -it -v /home/ubuntu/duke-data-service/docker/builds/dredd/dredd_scripts:/dds --env HOST_NAME=http://dds.host:3000/api/v1 --env MY_GENERATED_JWT=`docker-compose run rake api_test_user:create | tail -1` --link dukedataservice_server_1:dds.host --link dukedataservice_swift_1:swift.circle.host  dukedataservice_dredd /bin/bash
  #- 'docker-compose stop'

#deployment:
#  development:
#    branch: develop
#    commands:
#      - heroku run rake assets:clobber --app 'dukeds-dev'
#      - git push git@heroku.com:dukeds-dev.git $CIRCLE_SHA1:refs/heads/master:
#          timeout: 54000
#      - heroku run rake db:migrate --app 'dukeds-dev'
#      - heroku run rake db:seed --app 'dukeds-dev'
