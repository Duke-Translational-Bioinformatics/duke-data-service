machine:
  environment:
    DDSURL: http://0.0.0.0
    COMPOSE_FILE: docker-compose.circle.yml
  hosts:
    swift.circle.host: 0.0.0.0
  services:
    - docker

  # Version of ruby to use
  ruby:
    version:
      2.2.2

dependencies:
  pre:
    - curl -L https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64 > jq; sudo mv jq /usr/bin/jq; sudo chmod +x /usr/bin/jq
    - sudo pip install --upgrade docker-compose==1.3.0
    - docker-compose build
    - ./circle/launch_application.circle.sh

test:
  post:
    - './workflow/workflow.circle.sh `docker-compose run rake api_test_user:create | tail -1`'
    - 'cp apiary.apib ./docker/builds/dredd/dredd_scripts/apiary.apib'
    - 'docker run -it --env HOST_NAME=http://dds.host:3000/api/v1  --link dukedataservice_server_1:dds.host --env MY_GENERATED_JWT=`docker-compose -f dc-dev.utils.yml run rake api_test_user:create | tail -1` dukedataservice_dredd /bin/bash -c "cd /home/dredd_scripts; node dds-dredd.js"'

deployment:
  development:
    branch: develop
    commands:
      - heroku run rake assets:clobber --app 'dukeds-dev'
      - git push git@heroku.com:dukeds-dev.git $CIRCLE_SHA1:refs/heads/master:
          timeout: 54000
      - heroku run rake db:migrate --app 'dukeds-dev'
      - heroku run rake db:seed --app 'dukeds-dev'
